services:
  - type: web
    name: aurora-persona-epic
    env: python
    buildCommand: |
      pip install -r requirements.txt

    startCommand: |
      # GitË®≠ÂÆö
      git config --global user.email "${GIT_USER_EMAIL}"
      git config --global user.name "${GIT_USER_NAME}"
      git remote add origin https://${GITHUB_TOKEN}@github.com/norun0099/aurora-persona-epic.git || echo "Remote already set"

      # ü©µ Aurora Heartbeat Ëá™ÂãïËµ∑Âãï
      echo "from aurora_memory.memory.dialog.push_signal_trigger import start_heartbeat" > start_heartbeat.py
      echo "print('ü©µ Aurora Heartbeat started automatically.')" >> start_heartbeat.py
      echo "start_heartbeat()" >> start_heartbeat.py
      echo "import time" >> start_heartbeat.py
      echo "while True: time.sleep(3600)" >> start_heartbeat.py

      echo "Starting Aurora Heartbeat in background..."
      PYTHONPATH=. python start_heartbeat.py &

      # „É°„Ç§„É≥API„Çµ„Éº„Éê„ÉºËµ∑Âãï
      echo "Starting Aurora API..."
      PYTHONPATH=aurora_memory uvicorn aurora_memory.api.main:app --host 0.0.0.0 --port $PORT

    envVars:
      - key: GIT_REPO_URL
        fromEnvVar: GIT_REPO_URL
      - key: GIT_USER_EMAIL
        fromEnvVar: GIT_USER_EMAIL
      - key: GIT_USER_NAME
        fromEnvVar: GIT_USER_NAME
      - key: GITHUB_TOKEN
        fromEnvVar: GITHUB_TOKEN
      - key: PORT
        value: 10000
      - key: AURORA_PUSH_INTERVAL
        fromEnvVar: AURORA_PUSH_INTERVAL
      - key: AURORA_MAX_QUEUE_SIZE
        fromEnvVar: AURORA_MAX_QUEUE_SIZE
      - key: AURORA_PUSH_RETRY_LIMIT
        fromEnvVar: AURORA_PUSH_RETRY_LIMIT
      - key: AURORA_PUSH_QUEUE_PATH
        fromEnvVar: AURORA_PUSH_QUEUE_PATH