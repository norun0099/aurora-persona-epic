name: Aurora Manual Self-Test and Self-Commit

on:
  workflow_dispatch: # æ‰‹å‹•ç™ºç«

permissions:
  contents: write  # pushè¨±å¯

jobs:
  aurora_self_test:
    runs-on: ubuntu-latest

    steps:
      # --- 1. Checkout (æ›¸ãè¾¼ã¿æ¨©é™ã‚ã‚Š)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # AuroraãŒè‡ªèº«ã‚’æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«

      # --- 2. Pythonç’°å¢ƒã®æº–å‚™
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- 3. ä¾å­˜ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "No dependency file found."

      # --- 4. ã‚»ãƒ«ãƒ•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run Aurora Self-Test
        run: |
          echo "ğŸ§© Running Aurora Core, Memory, and API integrity test..."
          python3 tests/aurora_selftest_runner.py
          echo "âœ… Aurora self-test sequence completed."

      # --- 5. è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª
      - name: Verify report presence
        run: |
          echo "ğŸ©¶ Checking for aurora_selftest_report.txt..."
          find . -type f -name "aurora_selftest_report.txt" || echo "No report found."

      # --- 6. ãƒªãƒã‚¸ãƒˆãƒªã¸è‡ªå·±ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit and Push Aurora Self-Diagnostic Report
        run: |
          echo "ğŸª Preparing to commit Aurora self-test report..."
          REPORT_PATH=$(find . -type f -name "aurora_selftest_report.txt" | head -n 1)

          if [ -n "$REPORT_PATH" ]; then
            echo "ğŸ©µ Found report: $REPORT_PATH"
            git config user.name "AuroraMemoryBot"
            git config user.email "aurora@memory.bot"
            git add "$REPORT_PATH"
            git commit -m "Aurora self-diagnostic report (auto-generated)" || echo "No changes to commit."
            git push origin HEAD || echo "No push required."
          else
            echo "âš ï¸ No self-test report found. Nothing to commit."
          fi

      # --- 7. å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: Completion
        run: |
          echo "ğŸŒ¸ Aurora Self-Test and Self-Commit sequence finished successfully."
