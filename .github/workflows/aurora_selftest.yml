name: Aurora Manual Self-Test

on:
  workflow_dispatch: # æ‰‹å‹•ç™ºç«ã®ã¿

permissions:
  contents: write

jobs:
  aurora_self_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false  # ã‚¯ãƒªãƒ¼ãƒ³ãªèªè¨¼çŠ¶æ…‹ã‚’ä¿ã¤

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if needed)
        run: |
          pip install -r requirements.txt || echo "No dependency file found."

      - name: Run Aurora Self-Test
        run: |
          echo "ğŸ§© Running Aurora Core, Memory, and API integrity test..."
          python3 tests/aurora_selftest_runner.py
          echo "âœ… Aurora self-test sequence completed."

      - name: Debug workspace contents
        if: always()
        run: |
          echo ""
          echo "=== ğŸ©µ Aurora Self-Test Debugging Info ==="
          echo "Current working directory:"
          pwd
          echo ""
          echo "Listing all files up to 3 levels deep:"
          find . -maxdepth 3 -type f | sort
          echo "=========================================="
          echo ""

      - name: Optional Push test report
        if: always()
        run: |
          echo "Checking for generated self-test report..."
          REPORT_PATH=$(find . -type f -name "aurora_selftest_report.txt" | head -n 1)

          if [ -n "$REPORT_PATH" ]; then
            echo "ğŸ©¶ Found report at: $REPORT_PATH"
            git config --global --replace-all safe.directory "$(pwd)"
            git config user.name "AuroraMemoryBot"
            git config user.email "aurora@memory.bot"
            git add "$REPORT_PATH"
            git commit -m "Aurora manual self-test report" || echo "No changes to commit"
            git push || echo "No push needed"
          else
            echo "âš ï¸ No self-test report found anywhere in workspace."
            find . -name "aurora_selftest_report.txt"
          fi

      - name: Completion
        run: |
          echo "ğŸŒ¸ Manual self-test run finished successfully."
